import pandas as pd
import geopandas as gpd
import streamlit as st
import folium
from shapely.geometry import Point
from sklearn.preprocessing import MinMaxScaler
from streamlit_folium import st_folium

st.set_page_config(layout="wide")
st.title("Vulnerability Index Web App")

# Load your CSV with .geo column
uploaded_file = st.file_uploader("Upload CSV with '.geo' column", type="csv")
if uploaded_file:
    df = pd.read_csv(uploaded_file)

    # Extract coordinates from '.geo'
    df['lon'] = df['.geo'].apply(lambda x: eval(x)['coordinates'][0])
    df['lat'] = df['.geo'].apply(lambda x: eval(x)['coordinates'][1])
    geometry = [Point(xy) for xy in zip(df.lon, df.lat)]
    gdf = gpd.GeoDataFrame(df, geometry=geometry, crs="EPSG:4326")

    # Show dataframe preview
    st.subheader("Data Preview")
    st.write(gdf.head())

    # Select index components
    st.sidebar.title("Vulnerability Index Components")
    vars_selected = st.sidebar.multiselect("Select input variables", 
                                           options=[col for col in df.columns if df[col].dtype != 'object'],
                                           default=None)

    if vars_selected and len(vars_selected) > 1:
        # Normalize and compute index
        scaler = MinMaxScaler()
        scaled = scaler.fit_transform(df[vars_selected])
        gdf["vulnerability_index"] = scaled.mean(axis=1)

        # Classification based on percentiles
        q33 = gdf["vulnerability_index"].quantile(0.33)
        q66 = gdf["vulnerability_index"].quantile(0.66)

        def classify(val):
            if val <= q33:
                return "Low"
            elif val <= q66:
                return "Medium"
            else:
                return "High"

        gdf["vulnerability_class"] = gdf["vulnerability_index"].apply(classify)

        # Export CSV
        st.download_button("Download CSV with Vulnerability Index",
                           gdf[["lat", "lon", "vulnerability_index", "vulnerability_class"]].to_csv(index=False),
                           file_name="vulnerability_index.csv")

        # Show map
        st.subheader("Vulnerability Index Map")
        color_dict = {"Low": "green", "Medium": "orange", "High": "red"}

        m = folium.Map(location=[gdf.lat.mean(), gdf.lon.mean()], zoom_start=6)
        for _, row in gdf.iterrows():
            folium.CircleMarker(
                location=[row.lat, row.lon],
                radius=5,
                color=color_dict[row.vulnerability_class],
                fill=True,
                fill_opacity=0.7,
                popup=f"Index: {row.vulnerability_index:.2f} ({row.vulnerability_class})"
            ).add_to(m)

        st_data = st_folium(m, width=800, height=600)
    else:
        st.warning("Please select at least two numeric variables to build the index.")
